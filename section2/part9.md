# Pythonを用いた初心者向けAI実践講座(中級編) 12/21 配布資料

## 2-4 近似推論

　事後分布、周辺尤度、予測分布など問題によっては解析的に解くことが難しい
ものに関しては、近似的に解を求めることが多い。近似手法は大きく分けると、サンプリング、変分推論に大別される。

### 2-4-1 ギブスサンプリング

　分布全体の解析的な把握が難しい場合、期待値等の分布に関する部分的な統計
量を解析することは重要である。そのような各種統計量を得たい場合、分布
から複数の実現値をサンプリングし、その実現値を元に計算を行うことが
有効的である。

$$z_1^{(i)},z_2^{(i)},z_3^{(i)} \sim \ p(z_1,z_2,z_3) \tag{2.4.1}$$

　混合モデル等、複雑なモデルに関しては全てのサンプルを上記のように同時に
サンプルすることは難しいため、ギブスサンプリングという手法を用いて以下の
ようにサンプリングを行う。

$$z_1^{(i)} \sim \ p(z_1|z_2^{(i-1)},z_3^{(i-1)})\tag{2.4.2}$$
$$z_2^{(i)} \sim \ p(z_2|z_1^{(i)},z_3^{(i-1)})\tag{2.4.3}$$
$$z_3^{(i)} \sim \ p(z_3|z_1^{(i)},z_2^{(i)})\tag{2.4.4}$$

　この手法はMCMC（マルコフ連鎖モンテカルロ法）の手法の一つに分類されており、
サンプル数が十分に多い場合、繰り返しで得られた$z_k$は真の事後分布から
得られたものであると理論的に保証されている。


（1）ギブスサンプリングを用いて、ポアソン混合モデルの
事後分布$p(S,\vec{\lambda},\vec{\pi}|X)$からサンプリングを行う
アルゴリズムを導け。計算の際に、以下の関係式を用いてよい。

$$\ln Poi(x_n|\lambda_k) = x_n\ln\lambda - \lambda - \ln x!\tag{2.4.5}$$
$$\ln Cat(s_n|\pi) = \sum_{k=1}^{K}s_{n,k}\ln \pi_k\tag{2.4.6}$$
$$\ln Gam(\lambda_k|a,b) = (a-1)\ln\lambda_k - b\lambda_k + \ln \frac{b^a}{\Gamma(a)}\tag{2.4.7}$$
$$\ln Dir(\pi|\alpha) = \sum_{k=1}^{K}(\alpha_k-1)\ln\pi_k + \ln\frac{\Gamma(\sum_{k=1}^K\alpha_k)}{\prod_{k=1}^K\Gamma(\alpha_k)}\tag{2.4.8}$$

\clearpage

(略解) 以下の条件付き確率を計算し、それらからサンプリングを行う。

$$S \sim p(S|X,\Theta,\vec{\pi})\tag{2.4.9}$$
$$\Theta \sim p(\Theta|X,S,\vec{\pi})\tag{2.4.10}$$
$$\vec{\pi} \sim p(\vec{\pi}|X,\Theta,S)\tag{2.4.11}$$

解答は以下の通り

$$\vec{s}_n \sim Cat(\vec{s}_n|\vec{\eta}_n)\tag{2.4.12}$$
$$\eta_{n,k} \propto \exp{(x_n\ln\lambda_k-\lambda_k + \ln\pi_k)}\qquad s.t.\quad \sum_{k=1}^{K}\eta_{n,k}=1$$

$$\lambda_k \sim Gam(\lambda_k|\hat{a}_k, \hat{b}_k)\tag{2.4.13}$$
$$\hat{a}_k = \sum_{n=1}^{N}s_{n,k}x_n + a,\quad \hat{b}_k = \sum_{n=1}^{N}s_{n,k} + b$$

$$\vec{\pi} \sim Dir(\vec{\pi} | \hat{\vec{\alpha}})\tag{2.4.14}$$
$$\hat{\alpha}_k = \sum_{n=1}^{N}s_{n,k} + \alpha_k$$



### 2-4-2 平均場近似(変分推論)

　複雑な分布を最適化問題を解くことによってより簡単な近似分布で表現する手法を「変分推論」、「変分近似」と呼ぶ。事後分布は解析的に解けなくなる状況に陥ることがあるため、確率変数に特定の制約を付けた上で事後分布を近似する。

最適化にはKLダイバージェンスを使い、最小化問題として以下のように定式化される。


$$q_{opt} = argmin_q KL[q(z_1,z_2,z_3) | \ p(z_1,z_2,z_3)]\tag{2.4.15}$$

ここで、解が$q_{opt}(z_1,z_2,z_3) = p(z_1,z_2,z_3)$とならないように$q$に制約
をつける手法として、各確率変数に独立性の仮定をおく。

$$p(z_1,z_2,z_3) \approx q(z_1)q(z_2)q(z_3)\tag{2.4.16}$$

これを「平均場近似」と呼ぶ。

（2）平均場近似を用いて、ポアソン混合モデルの変分推論アルゴリズム
を導出せよ。ただし、事後分布$p(S,\vec{\lambda},\vec{\pi}|X)$
の潜在変数とパラメータを以下のように分けて近似せよ。

$$p(S,\vec{\lambda},\vec{\pi}|X) \approx q(S)q(\vec{\lambda},\vec{\pi})\tag{2.4.17}$$

